# Story Platform Architecture & Implementation Plan

## Overview

A platform for users to create engaging, LLM-powered stories. Users can start or continue stories, with chapters generated by an agent (IndexLlama + OpenAI). Supabase provides authentication, backend, and database. The frontend is a Vite React app, hosted on Netlify. The system is designed for extensibility (future LLMs, sharing, multimedia, agent customization).

---

## High-Level Architecture

### Components

1. **Frontend (Vite + React, Netlify)**
   - Supabase Auth integration
   - Story Dashboard (list, continue, start new, view completed)
   - Story Session UI (read, continue, prompt, feedback)
   - Minimalist, distraction-free design

2. **Backend (Supabase)**
   - Authentication (users)
   - Database (stories, chapters, user preferences)
   - Edge Functions (API endpoints for story generation, agent orchestration)

3. **Agent Service (IndexLlama + OpenAI)**
   - Receives prompts, story context, user preferences
   - Generates next chapter/content
   - Returns generated text to Edge Function

---

## Data Flow

1. User logs in (Supabase Auth).
2. User starts new story or continues existing one (Frontend → Edge Function).
3. Edge Function checks authentication, loads/saves story/chapter data (Supabase DB).
4. Edge Function calls IndexLlama agent with prompt, story context, user preferences.
5. Agent generates next chapter (OpenAI), returns to Edge Function.
6. Edge Function saves chapter, returns to Frontend.
7. Frontend displays new chapter, allows user to continue or end session.

---

## Supabase Database Schema (Initial)

- **users** (managed by Supabase Auth)
- **stories**
  - id (uuid, pk)
  - user_id (uuid, fk)
  - title (text)
  - status (enum: in_progress, completed)
  - created_at, updated_at (timestamps)
  - preferences (jsonb, for agent memory/settings)
- **chapters**
  - id (uuid, pk)
  - story_id (uuid, fk)
  - chapter_number (int)
  - content (text)
  - created_at (timestamp)
  - prompt (text, optional: user input for this chapter)
- **user_preferences** (optional, for global settings)
  - user_id (uuid, pk)
  - preferences (jsonb)

---

## Edge Functions

- **/api/start_story**: Start a new story (title, initial prompt, preferences)
- **/api/continue_story**: Continue existing story (story_id, prompt or auto-continue)
- **/api/list_stories**: List user’s stories (in progress, completed)
- **/api/get_story**: Get full story (for reading/sharing)
- **/api/update_preferences**: Update user or story preferences

---

## Frontend (Vite + React)

- **Auth flow** (Supabase)
- **Dashboard**: List stories, start new, continue, view completed
- **Story Session**: Read chapters, input prompt, continue, end session
- **Preferences UI**: Minimal for now, extensible for future customization
- **Minimalist UI**: Focus on text, easy navigation, distraction-free

---

## Mermaid Diagram

```mermaid
flowchart TD
    subgraph Frontend (Vite + React)
        A[User] --> B[Login/Signup]
        B --> C[Dashboard]
        C --> D[Story Session UI]
    end

    subgraph Backend (Supabase)
        E[Auth]
        F[DB: stories, chapters, preferences]
        G[Edge Functions]
    end

    subgraph Agent Service
        H[IndexLlama Agent]
        I[OpenAI LLM]
    end

    D -- API Calls --> G
    G -- Auth/DB --> E
    G -- DB Ops --> F
    G -- Story/Prompt, Preferences --> H
    H -- LLM API --> I
    I -- Generated Text --> H
    H -- Chapter Text --> G
    G -- Chapter/Story Data --> D
```

---

## Step-by-Step Implementation Plan

1. **Initialize Supabase project**
   - Set up Auth, create DB tables (users, stories, chapters, preferences)
2. **Set up Vite + React app**
   - Integrate Supabase Auth
   - Build Dashboard and Story Session UI (minimalist)
3. **Develop Edge Functions**
   - Implement endpoints for story management and agent orchestration
   - Integrate IndexLlama and OpenAI API
4. **Connect Frontend to Edge Functions**
   - API calls for story actions, display results
5. **Implement agent memory (per story/user)**
   - Store/retrieve preferences and context
6. **Polish UI/UX**
   - Ensure distraction-free, readable interface
7. **Deploy**
   - Frontend to Netlify, backend on Supabase

---

## Future Extensions

- Add sharing (read-only) for stories
- Render images based on story/characters
- Agent customization (age, reading level, topic avoidance)
- Support for additional LLMs and agent frameworks